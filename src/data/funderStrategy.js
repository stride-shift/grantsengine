/* ── Funder History & Strategy Engine ── */

const FUNDER_HISTORY = {
  "telkom": "returning", "telkom foundation": "returning",
  "get it done": "returning", "get it done foundation": "returning",
  "tk foundation": "returning", "sage": "returning", "sage foundation": "returning",
  "sap": "returning", "c-track": "returning", "ctrack": "returning",
  "eoh": "returning", "the field institute": "returning", "field institute": "returning",
};

export const isFunderReturning = name => {
  const n = (name || "").toLowerCase().trim();
  return Object.keys(FUNDER_HISTORY).some(k => n.includes(k) || k.includes(n));
};

export const PTYPES = {
  1: { label: "Standard Cohort — Partner-funded", students: 20, cost: 516000, perStudent: 25800, duration: "9 months", desc: "Partner provides infrastructure/stipends/laptops; d-lab provides coaching, curriculum, assessment, accreditation, LMS.", budget: "Travel R38K, Accommodation R38K, Staff S&T R16K, Shuttles R4K, Accreditation R5K, Assessment R95K, ChatGPT licenses R108K, LMS R11K, Coaches R200K", table: [["Coaches & curriculum","200,000"],["Software licenses","108,000"],["ICITP assessment","95,400"],["Travel","38,160"],["Accommodation","38,160"],["Staff S&T","15,722"],["LMS hosting","11,442"],["Accreditation","5,300"],["Airport shuttles","3,816"],["TOTAL","516,000"]] },
  2: { label: "Standard Cohort — d-lab Funded + Stipends + Laptops", students: 20, cost: 1597000, perStudent: 79860, duration: "9 months", desc: "d-lab provides everything including laptops and stipends. Full ownership model.", budget: "Base programme R516K + Laptops R318K (R15,900 × 20) + Stipends R763K (R4,240/student × 9mo)", table: [["Base programme (Type 1)","516,000"],["Laptops (R15,900 × 20)","318,000"],["Stipends (R4,240 × 20 × 9mo)","763,200"],["TOTAL","1,597,200"]] },
  3: { label: "Standard Cohort — With Stipends", students: 20, cost: 1236000, perStudent: 61800, duration: "9 months", desc: "Partner provides infrastructure + laptops; d-lab provides programme + stipends.", budget: "Programme R516K + Stipends R720K (R4,000/student × 9 months)", table: [["Base programme (Type 1)","516,000"],["Stipends (R4,000 × 20 × 9mo)","720,000"],["TOTAL","1,236,000"]] },
  4: { label: "FET High School Programme", students: 60, cost: 1079000, perStudent: 18000, duration: "3 years (425 hours)", desc: "Work-readiness journey for Grade 10–12 learners across 3 Schools of Specialisation. Weekly coaching + Saturday sessions + holiday Design Thinking sprints.", budget: "Subject specialist coaches R960K, FET Teacher Support R14K, Snacks/meals R81K, LMS R11K, Travel R8K, Accreditation R5K", table: [["Subject specialist coaches (R6K × 160 days)","960,000"],["Snacks & meals","81,000"],["FET Teacher Support","14,000"],["LMS hosting","11,442"],["Travel","8,000"],["Accreditation","5,300"],["TOTAL","1,079,742"]] },
  5: { label: "Corporate Programme (CCBA-style)", students: 63, cost: 651000, perStudent: 10333, duration: "6 months", desc: "Corporate-funded leadership development for graduate hires. Design Thinking sprints, group coaching, Enneagram profiles, reflection assessments.", budget: "Enneagram profiles R271K, Group coaching R183K, Phase/DT facilitation R122K, Reflection sessions R46K, Contingency R29K", table: [["Enneagram profiles (R4,300 × 63)","270,900"],["Group coaching (8 sessions)","183,000"],["Phase/DT facilitation","122,000"],["Reflection sessions (8)","46,000"],["Contingency","29,100"],["TOTAL","651,000"]] },
  6: { label: "Cyborg Habits Short Course", students: null, cost: null, perStudent: 930, duration: "4–6 weeks", desc: "Online behaviour-change challenge. Asynchronous, AI-supported work habits platform. US$49/learner.", budget: "US$49/learner (≈R930). Scales to any size.", table: [["Platform fee (US$49/learner)","varies"]] },
  7: { label: "Sci-Bono Employability Skills", students: 90, cost: 231790, perStudent: 2576, duration: "13 weeks (15 days)", desc: "Short-format: 7 AI coaching days + Design Thinking (1-day + 5-day sprints + 2 presentation days). Includes Cyborg Habits platform.", budget: "AI coaching R84K (2 coaches × R1K/hr × 6hrs × 7d) + DT coaching R64K (1 coach × R2K/hr × 4hrs × 8d) + Cyborg Habits R84K (US$49 × 90)", table: [["AI coaching (2 coaches × 7 days)","84,000"],["DT coaching (1 coach × 8 days)","64,000"],["Cyborg Habits platform (90 × US$49)","83,790"],["TOTAL","231,790"]] },
};

export const detectType = g => {
  const n = (g.notes || "").toLowerCase();
  for (let i = 7; i >= 1; i--) { if (n.includes(`type ${i}`) || n.includes(`(type ${i})`)) return PTYPES[i]; }
  if (g.ask <= 250000) return PTYPES[7];
  if (g.ask <= 550000) return PTYPES[1];
  if (g.ask <= 700000) return PTYPES[5];
  if (g.ask >= 1500000) return PTYPES[2];
  if (g.ask >= 1000000) return PTYPES[3];
  return PTYPES[1];
};

export const multiCohortInfo = g => {
  const n = (g.notes || "").toLowerCase();
  const m = n.match(/(\d+)\s*[×x]?\s*type\s*(\d)/i) || n.match(/(\d+)\s*cohorts?/i);
  return m ? { count: parseInt(m[1]), typeNum: m[2] ? parseInt(m[2]) : 1 } : null;
};

export const funderStrategy = g => {
  const f = g.funder || "";
  const t = g.type || "";
  const focus = (g.focus || []).join(", ");
  const returning = isFunderReturning(f);
  const pt = detectType(g);
  const mc = multiCohortInfo(g);
  const angles = {
    "DG Murray Trust": { lead: "youth transition from education to employment", hook: "DGMT champions systemic change in how young South Africans transition from learning to earning. d-lab's model — where 85% of graduates are employed within 3 months — is exactly the kind of evidence-based intervention that shifts transition outcomes at scale.", sections: ["Theory of Change", "Systems Change", "Evidence Base"], lang: "systems thinking, transition outcomes, evidence-based, catalytic" },
    "MICT SETA": { lead: "NQF-aligned digital skills for the MICT sector", hook: "South Africa's MICT sector faces a critical skills gap. d-lab's ICITP-accredited programme produces ICDL-certified, AI-fluent graduates ready for the digital economy — aligned with NSDP 2030 priorities and MICT sector skills plan.", sections: ["SAQA/NQF Alignment", "Sector Skills Plan Fit", "WSP/ATR Compliance", "Accreditation"], lang: "NQF levels, SAQA alignment, sector skills plan, learnerships, WSP/ATR, transformation" },
    "Industrial Development Corp": { lead: "digital industrialisation and youth economic participation", hook: "The IDC's mandate to drive inclusive industrialisation aligns directly with d-lab's partner delivery model — equipping youth in under-served communities with AI and digital skills that enable them to participate in the emerging digital economy. Our partner-funded delivery model keeps costs low while reaching deep into communities that formal institutions miss.", sections: ["Rural Impact", "Women & Youth", "Economic Development", "Job Creation"], lang: "industrialisation, economic development, rural, women, job creation" },
    "Vodacom Foundation": { lead: "digital inclusion and connectivity for youth", hook: "Vodacom's vision of an inclusive digital society requires more than connectivity — it requires capability. d-lab turns connectivity into career outcomes, teaching young people to use AI and digital tools as daily working instruments.", sections: ["Digital Inclusion", "Brand Alignment", "B-BBEE Impact", "Scale"], lang: "digital inclusion, connected youth, brand alignment, B-BBEE, scale" },
    "Momentum Group": { lead: "financial independence through employability", hook: "Momentum's purpose — enabling financial well-being for every generation — starts with employment. d-lab takes young people from unemployment to their first paycheck, building the foundation for lifelong financial independence.", sections: ["Financial Independence", "Youth Empowerment", "Measurable Outcomes"], lang: "financial well-being, independence, generational impact" },
    "FirstRand Foundation": { lead: "innovative approaches to youth employment", hook: "FirstRand Foundation funds bold ideas that can change the trajectory of young South Africans' lives. d-lab's AI-native model — where completion rates are nearly double the sector average — represents a genuinely new approach to an old problem.", sections: ["Innovation", "Scalability", "Evidence", "Sustainability"], lang: "innovation, bold, scalable, evidence-based" },
    "Microsoft South Africa": { lead: "AI skills and digital transformation for youth", hook: "Microsoft's commitment to skilling South Africans for the AI economy aligns perfectly with d-lab — the only NPO in South Africa that embeds AI tools from day one. Our students don't learn ABOUT AI; they work WITH AI every day.", sections: ["AI Integration", "Tech Platform", "Digital Skills Pipeline", "Innovation"], lang: "AI-native, digital transformation, skilling, technology, cloud" },
    "Google.org": { lead: "using AI to solve youth unemployment at scale", hook: "Google.org supports organisations using technology to create opportunity for underserved communities. d-lab's AI-native model — with in-house tools like Language Leveller and Assessornator — demonstrates how AI can make high-quality skills training accessible and scalable.", sections: ["AI for Social Good", "Technology Innovation", "Scale Model", "Evidence"], lang: "AI for good, scale, innovation, measurable impact, technology" },
    "Mastercard Foundation": { lead: "dignified and fulfilling work for young Africans", hook: "The Young Africa Works strategy envisions 30 million young people in dignified work. d-lab's outcomes — 85% employment, 92% completion — prove that AI-powered, mentored skills training can deliver exactly the kind of quality employment outcomes the Foundation seeks.", sections: ["Young Africa Works Alignment", "Dignified Work", "Scale Pathway", "Africa-wide Model"], lang: "dignified work, young Africa, scale, Africa-wide, systems change" },
    "Telkom Foundation": { lead: "digital skills that connect to real employment", hook: "As a returning partner, Telkom Foundation has seen firsthand what d-lab achieves — your investment helped us build a complete training system — 60 students, 92% completion, 85% employment. That's nearly double the sector average. We're ready to deepen that impact with an expanded programme.", sections: ["Partnership Renewal", "Growth Story", "Outcomes Since Last Funding", "Next Phase"], lang: "partnership, digital skills, connectivity, growth, deepening impact" },
    "Sage Foundation": { lead: "building entrepreneurial and tech-enabled young professionals", hook: "Sage Foundation's focus on economically empowering young people through technology aligns with d-lab's core mission. As a returning partner, you've seen our students go from unemployed to employed, from digitally excluded to AI-fluent.", sections: ["Entrepreneurship", "Technology Empowerment", "Partnership History", "Growth"], lang: "entrepreneurship, technology, empowerment, accounting skills" },
    "SAP": { lead: "enterprise technology skills for the next generation", hook: "SAP's commitment to preparing Africa's youth for the digital economy runs parallel to d-lab's mission. Our AI-native approach produces graduates who are fluent in the kind of enterprise thinking and digital problem-solving that SAP champions.", sections: ["Enterprise Skills", "Digital Readiness", "Partnership Deepening"], lang: "enterprise, digital economy, purpose-driven, technology" },
    "Nedbank Private Wealth": { lead: "transforming lives through accredited vocational skills", hook: "Nedbank Private Wealth's charitable foundations exist to create lasting change. d-lab's programme — combining ICITP-accredited vocational training with AI literacy and stipend support — transforms unemployed youth into employable, digitally fluent professionals, with 85% in work within 3 months of graduation.", sections: ["Accredited Training", "Stipend Model", "Community Impact", "Cost Effectiveness"], lang: "charitable, lasting change, accredited, vocational, transformation" },
    "Gauteng Dept of Education": { lead: "school-to-work pipeline for FET learners", hook: "The Gauteng Department of Education's Schools of Specialisation need a work-readiness partner that can bridge the gap between classroom learning and career readiness. d-lab's 3-year FET programme does exactly this — 425 hours of AI skills, Design Thinking, and employability coaching.", sections: ["Curriculum Alignment", "Schools of Specialisation", "Teacher Development", "Learner Outcomes"], lang: "curriculum, work-readiness, FET, Schools of Specialisation, CAPS alignment" },
    "Sci-Bono Discovery Centre": { lead: "cost-effective employability skills for school-leavers", hook: "Sci-Bono's mission to inspire young people in STEM extends naturally into employability. d-lab's 13-week programme — at just R2,547 per learner — turns 90 school-leavers into AI-literate, Design Thinking-capable candidates ready for the workplace.", sections: ["Cost Effectiveness", "STEM Extension", "Practical Skills", "Scale"], lang: "STEM, discovery, practical skills, cost-effective" },
    "The Field Institute / CCBA": { lead: "leadership development for graduate professionals", hook: "CCBA's Future Leaders programme has proven that combining Design Thinking, Enneagram profiling, and structured coaching creates measurably stronger leaders. The 2027 programme builds on this success with refined delivery and deeper integration.", sections: ["Programme Evolution", "Leadership Outcomes", "Delivery Model"], lang: "leadership, graduate development, coaching, self-awareness" },
    "National Skills Fund": { lead: "national digital skills aligned with NSDP 2030", hook: "The NSF's mandate to fund skills development projects aligned with national priorities makes d-lab's AI-native programme a natural fit. Our scalable model — delivering ICITP-accredited, ICDL-certified graduates — directly advances NSDP 2030 outcomes.", sections: ["NSDP 2030 Alignment", "Scalable Delivery", "Accreditation", "Scale"], lang: "NSDP 2030, national priorities, accredited, scalable, transformation" },
    "Old Mutual Foundation": { lead: "education that leads to economic participation", hook: "Old Mutual Foundation's commitment to responsible business through education and skills development aligns with d-lab's proven model — taking young people from unemployment to economic participation through AI-powered, mentored training.", sections: ["Economic Participation", "Education Outcomes", "Responsible Business"], lang: "responsible business, education, economic participation, financial literacy" },
    "Oppenheimer Memorial Trust": { lead: "education access for under-resourced communities", hook: "OMT's focus on education in under-resourced communities aligns with d-lab's partner-funded delivery model — bringing world-class AI and digital skills training to communities where young people have talent but no pathway, through local partners who provide the infrastructure while d-lab provides the system.", sections: ["Rural Access", "Education Quality", "Community Impact"], lang: "education, under-resourced, rural, access, community" },
    "W&R SETA": { lead: "digital skills for the wholesale and retail sector", hook: "The wholesale and retail sector's digital transformation demands a new kind of worker — AI-fluent, design-thinking capable, and digitally confident. d-lab's programme produces exactly these graduates, with 85% employment outcomes.", sections: ["Sector Skills Plan", "Digital Transformation", "Accreditation", "Employment Outcomes"], lang: "wholesale, retail, sector skills plan, digital transformation, learnerships" },
    "Raith Foundation": { lead: "innovative solutions to systemic youth unemployment", hook: "Raith Foundation funds organisations that take genuinely innovative approaches to South Africa's deepest social challenges. d-lab's AI-native model — the only one of its kind in South African NPO space — represents a fundamentally new approach to youth unemployment.", sections: ["Innovation", "Systemic Change", "Evidence", "Multi-year Vision"], lang: "innovative, systemic, social justice, multi-year" },
  };
  const a = angles[f] || { lead: focus || "youth employment and digital skills", hook: `${f}'s commitment to social impact aligns with d-lab's mission to equip young South Africans with AI-native digital skills and employability competencies. Our 92% completion rate and 85% employment outcomes demonstrate a model that works.`, sections: ["Impact", "Programme", "Budget", "Sustainability"], lang: "impact, youth, digital skills, employment" };
  const structures = {
    "Corporate CSI": ["Cover Letter", "Executive Summary", "B-BBEE Value Proposition", "Programme Overview", "Impact & Outcomes", "Budget", "Brand Alignment & Visibility", "Sustainability", "Appendices"],
    "Government/SETA": ["Cover Letter", "Executive Summary", "Regulatory Alignment (NQF/SAQA/NSDP)", "Organisational Capacity", "Programme Description", "Accreditation & Quality Assurance", "Budget & Value for Money", "M&E Framework", "Transformation & Equity", "Appendices"],
    "International": ["Cover Letter", "Executive Summary", "Problem Analysis", "Theory of Change", "Programme Design", "Impact Framework (SDG-aligned)", "Budget (with cost-effectiveness analysis)", "Sustainability & Exit Strategy", "Risk Management", "Safeguarding", "Appendices"],
    "Foundation": ["Cover Letter", "Executive Summary", "The Challenge", "Our Approach", "Evidence of Impact", "Programme Details", "Budget", "Sustainability", "Organisational Background", "Appendices"],
    "Tech Company": ["Cover Letter", "Executive Summary", "Technology & Innovation", "Programme Design", "AI Integration", "Impact Metrics", "Budget", "Scale Pathway", "Appendices"],
  };
  return { ...a, returning, pt, mc, structure: structures[t] || structures["Foundation"] };
};
